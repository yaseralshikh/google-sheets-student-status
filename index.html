<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ù‡Ø§Ø¯Ø© Ø§Ø¬ØªÙŠØ§Ø² Ø§Ø®ØªØ¨Ø§Ø±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap + Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .certificate {
      display: none;
      margin-top: 30px;
      padding: 40px;
      border: 8px solid #3f70f4;
      text-align: center;
      font-family: 'Arial', sans-serif;
      background-color: white;
    }
    .certificate h2 {
      color: #3f70f4;
    }
    .certificate img {
      width: 120px;
      margin-bottom: 15px;
    }
    @media print {
      .certificate img {
        max-width: 150px !important;
        max-height: 80px !important;
        width: auto !important;
        height: auto !important;
        display: block !important;
        margin: 0 auto 15px auto !important;
      }
      body * {
        visibility: hidden !important;
      }
      .certificate, .certificate * {
        visibility: visible !important;
      }
      .certificate {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        page-break-before: always;
      }
    }
  </style>
</head>
<body class="text-center p-4">
  <h2 class="text-primary mb-4"><i class="fas fa-check-circle"></i> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø¬ØªÙŠØ§Ø² Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
  <p class="text-muted">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡</p>

  <input type="text" id="studentIdInput" class="form-control w-50 mx-auto mb-3 text-center" list="student-history" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
  <datalist id="student-history"></datalist>

  <button class="btn btn-success mb-3" onclick="checkResult()">
    <i class="fas fa-search"></i> ØªØ­Ù‚Ù‚
  </button>

  <div id="result" class="mb-3"></div>

  <div class="d-flex justify-content-center gap-2 mb-4">
    <button class="btn btn-outline-primary d-none" id="printBtn" onclick="printCertificate()">
      <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    </button>
    <button class="btn btn-outline-danger d-none" id="pdfBtn" onclick="savePDF()">
      <i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ PDF
    </button>
  </div>

  <div class="certificate" id="certificate">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA..." alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
    <h2>ðŸ“˜ Ø´Ù‡Ø§Ø¯Ø© Ø§Ø¬ØªÙŠØ§Ø² Ø§Ø®ØªØ¨Ø§Ø±</h2>
    <p>Ù†Ø´Ù‡Ø¯ Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨</p>
    <p><strong id="studentName">[Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨]</strong></p>
    <p>ÙˆØ±Ù‚Ù… Ù‡ÙˆÙŠØªÙ‡ <strong id="studentCode">[Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨]</strong></p>
    <p>Ù‚Ø¯ Ø§Ø¬ØªØ§Ø² Ø¨Ù†Ø¬Ø§Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>
  </div>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    google.charts.load('current', {packages: ['table']});

    function convertArabicToEnglish(input) {
      return input.replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
    }

    function saveToHistory(id) {
      let history = JSON.parse(localStorage.getItem('studentHistory') || "[]");
      if (!history.includes(id)) {
        history.push(id);
        localStorage.setItem('studentHistory', JSON.stringify(history));
        updateDatalist(history);
      }
    }

    function updateDatalist(history = null) {
      const list = document.getElementById("student-history");
      list.innerHTML = "";
      const values = history || JSON.parse(localStorage.getItem('studentHistory') || "[]");
      values.forEach(id => {
        const option = document.createElement("option");
        option.value = id;
        list.appendChild(option);
      });
    }

    function checkResult() {
      let studentId = document.getElementById('studentIdInput').value.trim();
      studentId = convertArabicToEnglish(studentId);
      const resultDiv = document.getElementById('result');
      const certDiv = document.getElementById('certificate');
      const certName = document.getElementById('studentName');
      const certCode = document.getElementById('studentCode');
      const printBtn = document.getElementById('printBtn');
      const pdfBtn = document.getElementById('pdfBtn');

      resultDiv.innerHTML = '';
      certDiv.style.display = 'none';
      certName.innerHTML = '';
      certCode.innerHTML = '';
      printBtn.classList.add('d-none');
      pdfBtn.classList.add('d-none');

      if (!studentId) {
        resultDiv.innerHTML = '<div class="alert alert-warning">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>';
        return;
      }

      const spreadsheetId = '13Wxrao8bnaHFbf7dcy28epoUI73LRSbku7CTbNUvIRc';
      const query = new google.visualization.Query(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=Data`);

      query.send(response => {
        if (response.isError()) {
          resultDiv.innerHTML = `<div class="alert alert-danger">Ø­Ø¯Ø« Ø®Ø·Ø£: ${response.getMessage()}</div>`;
          return;
        }

        const data = response.getDataTable();
        let found = false;

        for (let i = 0; i < data.getNumberOfRows(); i++) {
          const id = data.getValue(i, 0)?.toString().trim();
          const name = data.getValue(i, 1);
          const status = data.getValue(i, 2);

          if (id === studentId) {
            found = true;
            saveToHistory(studentId);
            if (status === 'Ù…Ø¬ØªØ§Ø²') {
              resultDiv.innerHTML = `<div class="alert alert-success">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ ${name}ØŒ Ù„Ù‚Ø¯ Ø§Ø¬ØªØ²Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>`;
              certDiv.style.display = 'block';
              certName.innerText = name;
              certCode.innerText = id;
              printBtn.classList.remove('d-none');
              pdfBtn.classList.remove('d-none');
            } else {
              resultDiv.innerHTML = `<div class="alert alert-danger">Ø¹Ø°Ø±Ù‹Ø§ ${name}ØŒ Ù„Ù… ØªØ¬ØªØ² Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>`;
            }
            break;
          }
        }

        if (!found) {
          resultDiv.innerHTML = '<div class="alert alert-warning">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
        }
      });
    }

    function printCertificate() {
      window.print();
    }

    async function savePDF() {
      const {{ jsPDF }} = window.jspdf;
      const doc = new jsPDF({orientation: 'landscape', unit: 'pt', format: 'a4'});
      doc.html(document.getElementById("certificate"), {
        callback: function (doc) {
          doc.save("Ø´Ù‡Ø§Ø¯Ø©_Ø§Ù„Ø·Ø§Ù„Ø¨.pdf");
        },
        x: 20,
        y: 20
      });
    }

    updateDatalist();
  </script>
</body>
</html>
